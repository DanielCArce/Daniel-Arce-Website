---
import "../styles/global.css";
interface Props {
    companyName?: string;
    currentPath?: string;
}

const { companyName = "DanielCArce", currentPath = "/" } = Astro.props;

const nav = [
    { name: "Inicio", href: "/#inicio" }, // Añadimos ID al inicio
    { name: "Servicios", href: "/#servicios" },
    { name: "Blog", href: "/blog" },
    { name: "Contacto", href: "/#contacto" },
];
---

<header
    class="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-slate-200/50 transition-all"
>
    <div class="mx-auto max-w-7xl px-6 lg:px-12">
        <div class="flex h-20 items-center justify-between">
            <a href="/#inicio" class="group flex items-center gap-2">
                <div
                    class="w-10 h-10 bg-slate-900 text-white rounded-xl flex items-center justify-center font-black text-xl group-hover:bg-emerald-600 transition-colors"
                >
                    D
                </div>
                <span class="font-bold text-xl tracking-tighter text-slate-900">
                    Daniel<span class="text-emerald-600">CArce</span>
                </span>
            </a>

            <nav id="desktop-nav" class="hidden md:flex items-center gap-1">
                {
                    nav.map((item) => {
                        // El estado inicial para el Blog se mantiene vía servidor
                        const isBlogActive =
                            item.href === "/blog" &&
                            currentPath.startsWith("/blog");

                        return (
                            <a
                                href={item.href}
                                data-nav-link
                                class={`px-4 py-2 rounded-full text-sm font-bold transition-all duration-300
                                ${
                                    isBlogActive
                                        ? "bg-slate-900 text-white shadow-lg shadow-slate-200"
                                        : "text-slate-600 hover:text-emerald-600 hover:bg-emerald-50"
                                }`}
                            >
                                {item.name}
                            </a>
                        );
                    })
                }
            </nav>

            <button
                id="nav-toggle"
                aria-label="Abrir menú"
                class="md:hidden p-2 text-slate-900 hover:bg-slate-100 rounded-xl transition"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-6 w-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>
        </div>
    </div>

    <div
        id="mobile-menu"
        class="md:hidden hidden bg-white border-t border-slate-100 animate-fade-in"
    >
        <div class="px-6 py-6 space-y-3">
            {
                nav.map((item) => (
                    <a
                        href={item.href}
                        data-nav-link
                        class="block w-full px-4 py-3 rounded-2xl text-base font-bold text-slate-700 hover:bg-emerald-50 hover:text-emerald-600 transition"
                    >
                        {item.name}
                    </a>
                ))
            }
        </div>
    </div>
</header>

<script>
    const setupNav = () => {
        const sections = document.querySelectorAll(
            "section[id], main[id], div[id]",
        );
        const navLinks = document.querySelectorAll("[data-nav-link]");

        const activeClass = [
            "bg-slate-900",
            "text-white",
            "shadow-lg",
            "shadow-slate-200",
        ];
        const idleClass = ["text-slate-600"];

        const observerOptions = {
            root: null,
            rootMargin: "-20% 0px -70% 0px", // Ajuste para detectar la sección central
            threshold: 0,
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute("id");

                    navLinks.forEach((link) => {
                        const href = link.getAttribute("href");
                        // Verificamos si el link termina con el ID de la sección actual
                        if (href && href.endsWith(`#${id}`)) {
                            link.classList.add(...activeClass);
                            link.classList.remove(...idleClass);
                        } else if (
                            !href?.includes("/blog") ||
                            !window.location.pathname.startsWith("/blog")
                        ) {
                            // No removemos activo si estamos realmente en la página de blog
                            link.classList.remove(...activeClass);
                            link.classList.add(...idleClass);
                        }
                    });
                }
            });
        }, observerOptions);

        sections.forEach((section) => observer.observe(section));
    };

    // Lógica del menú móvil
    const btn = document.getElementById("nav-toggle");
    const menu = document.getElementById("mobile-menu");

    btn?.addEventListener("click", () => menu?.classList.toggle("hidden"));

    // Ejecutar al cargar
    setupNav();

    // Re-ejecutar si usas transiciones de página de Astro
    document.addEventListener("astro:after-swap", setupNav);
</script>

<style>
    .animate-fade-in {
        animation: fadeIn 0.2s ease-out forwards;
    }
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
